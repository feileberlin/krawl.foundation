name: ðŸ“¸ Telegram Flyer Processing

on:
  repository_dispatch:
    types: [telegram_flyer_submission]

permissions:
  contents: write
  issues: write
  workflows: write

jobs:
  process-flyer:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-deu

      - name: Download Telegram photo
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          mkdir -p .cache/telegram
          
          FILE_ID="${{ github.event.client_payload.file_id }}"
          FILENAME="${{ github.event.client_payload.filename }}"
          
          echo "ðŸ“¥ Downloading Telegram photo: $FILE_ID"
          
          # Get file path from Telegram API
          FILE_PATH=$(curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getFile?file_id=${FILE_ID}" \
            | python3 -c "import sys, json; print(json.load(sys.stdin)['result']['file_path'])")
          
          # Download file
          curl -s "https://api.telegram.org/file/bot${TELEGRAM_TOKEN}/${FILE_PATH}" \
            -o ".cache/telegram/${FILENAME}"
          
          echo "âœ… Saved: .cache/telegram/${FILENAME}"
          ls -lh .cache/telegram/

      - name: Run OCR and extract event data
        id: ocr
        run: |
          echo "ðŸ” Running OCR on uploaded flyer..."
          
          # Use image_extractor in batch mode (non-interactive)
          python3 cli/image_extractor.py local .cache/telegram/ --ocr --batch --output-json events_extracted.json
          
          # Parse results
          if [ -f events_extracted.json ]; then
            echo "âœ… OCR completed"
            cat events_extracted.json
            echo "extracted=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ OCR failed - creating minimal draft"
            echo "extracted=false" >> $GITHUB_OUTPUT
          fi

      - name: Create event draft
        run: |
          mkdir -p _events
          
          TIMESTAMP=$(date '+%Y-%m-%d_%H%M%S')
          USER_ID="${{ github.event.client_payload.telegram_user_id }}"
          USERNAME="${{ github.event.client_payload.telegram_username }}"
          FILENAME="${{ github.event.client_payload.filename }}"
          
          # Create draft JSON
          cat > "_events/telegram-draft-${TIMESTAMP}.json" << 'EOF'
          {
            "status": "draft",
            "source": "telegram",
            "telegram_user_id": "${{ github.event.client_payload.telegram_user_id }}",
            "telegram_username": "${{ github.event.client_payload.telegram_username }}",
            "image_file": "${{ github.event.client_payload.filename }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "title": "Event Draft (OCR pending)",
            "venue": "TBD",
            "date": "TBD",
            "time": "TBD",
            "description": "Automatically extracted from Telegram submission. Please review and complete.",
            "needs_review": true
          }
          EOF
          
          # If OCR succeeded, merge extracted data
          if [ "${{ steps.ocr.outputs.extracted }}" == "true" ] && [ -f events_extracted.json ]; then
            echo "ðŸ“ Merging OCR data into draft..."
            python3 << 'PYTHON'
          import json
          from pathlib import Path
          
          draft_file = list(Path('_events').glob('telegram-draft-*.json'))[0]
          draft = json.load(open(draft_file))
          
          if Path('events_extracted.json').exists():
              extracted = json.load(open('events_extracted.json'))
              if extracted:
                  first_event = extracted[0]
                  draft.update({
                      'title': first_event.get('title', draft['title']),
                      'venue': first_event.get('venue', draft['venue']),
                      'date': first_event.get('date', draft['date']),
                      'time': first_event.get('time', draft['time']),
                      'description': first_event.get('description', draft['description']),
                      'ocr_text': first_event.get('ocr_text', ''),
                  })
          
          with open(draft_file, 'w') as f:
              json.dump(draft, f, indent=2, ensure_ascii=False)
          PYTHON
          fi
          
          echo "âœ… Draft created: $(ls _events/telegram-draft-*.json)"

      - name: Commit draft
        run: |
          git config user.name "krawl-bot"
          git config user.email "bot@krawl.foundation"
          
          git add _events/telegram-draft-*.json .cache/telegram/
          git commit -m "ðŸ“¸ New event draft from Telegram (@${{ github.event.client_payload.telegram_username }})" || echo "No changes"
          git push

      - name: Trigger draft notification
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'notify-pending-drafts.yml',
              ref: 'main',
              inputs: {
                threshold_hours: '0'
              }
            });

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“¸ Telegram Flyer Processing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Submitter:** @${{ github.event.client_payload.telegram_username }} (ID: ${{ github.event.client_payload.telegram_user_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${{ github.event.client_payload.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "**Draft:** $(ls _events/telegram-draft-*.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Draft created and ready for review" >> $GITHUB_STEP_SUMMARY
